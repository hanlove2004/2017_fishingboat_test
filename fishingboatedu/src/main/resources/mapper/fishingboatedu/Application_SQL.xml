<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="application">

	<!-- 교육신청 가능 목록 조회 -->
	<select id="selectEducationList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT 
				A.SEQ AS EDU_SEQ,
				A.EDU_CHASU,
				A.EDU_CD,
				SUBSTR(A.EDU_START_DATE,0,4) AS EDU_YEAR,
				B.EDU_CODE_NAM
			FROM 
				TB_EDU_INFOR_T A,
				TB_EDU_CODE_T B
			WHERE 
				A.EDU_STATE = '2'
				AND A.EDU_CD = B.EDU_CODE(+)
		]]>
	</select>
	
	<!-- 접수번호 조회 생성 -->
	<select id="selectEduNum" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				REPLACE(EDU_NUM_BASE, ' ', '') AS EDU_NUM
			FROM
				(
					SELECT
						SUBSTR(EDU_START_DATE,0,4) || '-' || LPAD(EDU_CHASU, 2, '0') || '-' || EDU_CD || (
							SELECT
								LPAD(NVL(MAX(EDU_SEQ), 0) + 1, 3, '0')
							FROM
								TB_EDU_APPLICATION_T
							WHERE
								EDU_INFOR_SEQ = #{edu_infor_seq}
						) AS EDU_NUM_BASE
					FROM
						TB_EDU_INFOR_T
					WHERE
						SEQ = #{edu_infor_seq}
				)
		]]>
	</select>

	<!-- 교육신청 insert -->
	<insert id="insertApplication" parameterType="hashmap">
		<![CDATA[
			INSERT INTO
				TB_EDU_APPLICATION_T
				(
					SEQ,
					EDU_SEQ,
					EDU_NUM,
					EDU_INFOR_SEQ,
					EDU_IMG_URL,
					EDU_IMG_ORG_NAM,
					EDU_IMG_SAV_NAM,
					EDU_NAM,
					EDU_BIRTH,
					EDU_EMAIL,
					EDU_PHONE,
					EDU_POST_CD,
					EDU_ADDR1,
					EDU_ADDR2,
					EDU_DOM_YN,
					EDU_BROKE_APP_YN,
					EDU_PWD,
					EDU_REG_DAT,
					EDU_APP_STATE,
					EDU_BROKER_SIDO,
					EDU_BROKER_GUGUN,
					EDU_BROKER_YN
				)
			VALUES 
				(
					(
						SELECT 
							NVL(MAX(SEQ),0) + 1
						FROM
							TB_EDU_APPLICATION_T
					),
					(
						SELECT 
							NVL(MAX(EDU_SEQ), 0) + 1
						FROM
							TB_EDU_APPLICATION_T
						WHERE
							EDU_INFOR_SEQ = #{edu_infor_seq}
					),
					#{edu_num},
					#{edu_infor_seq},
					'/education',
					#{ORIGINAL_FILE_NAME},
					#{STORED_FILE_NAME},
					#{name},
					#{birth},
					#{emailtrue},
					#{phone},
					#{sample6_postcode},
					#{sample6_address},
					#{sample6_address2},
					#{dormitoryYN},
					'n',
					#{pwd},
					SYSDATE,
					's2',
					#{broker_sido},
					#{broker_gugun},
					#{brokerYN}
				)
		]]>
	</insert>
	
	<!-- 교육신청 반명함 사진 정보 insert -->
	<insert id="insertApplicationImage" parameterType="hashmap">
		<![CDATA[
			INSERT INTO 
				TB_FILE_T 
				(	
					SEQ, 
					BOARD_SEQ,
					ORG_FLE_NAM, 
					REG_DAT, 
					SAV_FLE_NAM, 
					BOARD_TYPE
				)
			VALUES 
				(
					(
						SELECT 
							NVL(MAX(SEQ), 0) + 1 
						FROM
							TB_FILE_T
					),
					(
						SELECT 
							NVL(MAX(SEQ),0) + 1
						FROM
							TB_EDU_APPLICATION_T
					),
					#{ORIGINAL_FILE_NAME},
					SYSDATE,
					#{STORED_FILE_NAME},
					#{board_type}
				)
		]]>
	</insert>
	
	<!-- 교육신청서 상세정보 -->
	<select id="selectApplication" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				A.SEQ,
				A.EDU_SEQ,
				A.EDU_NUM,
				A.EDU_INFOR_SEQ,
				A.EDU_IMG_SAV_NAM,
				A.EDU_NAM,
				A.EDU_BIRTH,
				A.EDU_EMAIL,
				A.EDU_PHONE,
				A.EDU_POST_CD,
				A.EDU_ADDR1,
				A.EDU_ADDR2,
				A.EDU_DOM_YN,
				A.EDU_APP_STATE,
				B.EDU_START_DATE,
				B.EDU_END_DATE,
				B.EDU_LOC,
				B.EDU_CHASU,
				B.EDU_CD,
				SUBSTR(B.EDU_START_DATE,0,4) AS EDU_YEAR,
				C.EDU_CODE_NAM
			FROM
				TB_EDU_APPLICATION_T A,
				TB_EDU_INFOR_T B,
				TB_EDU_CODE_T C
			WHERE
				A.EDU_NUM = #{edu_num}
				AND A.EDU_INFOR_SEQ = B.SEQ(+)
				AND B.EDU_CD = C.EDU_CODE(+)
		]]>
	</select>
	
	<!-- 교육신청 취소 -->
	<update id="updateApplicationState" parameterType="hashmap">
		<![CDATA[
			UPDATE 
				TB_EDU_APPLICATION_T 
			SET
				EDU_APP_STATE = #{edu_app_state}
			WHERE 
				SEQ = #{seq}
				AND EDU_NUM = #{edu_num}
		]]>
	</update>
	
	<!-- 중개업 수행 지역 (시도) 조회 -->
	<select id="selectBrokerSidoList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				*
			FROM
				TB_EDU_CODE_T
			WHERE
				EDU_CATEGORY = 'EDU_BROKER_SIDO'
		]]>
	</select>
	
	<!-- 중개업 수행 지역 (구군) 조회 -->
	<select id="selectBrokerGugunList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				*
			FROM
				TB_EDU_CODE_T
			WHERE
				EDU_CATEGORY = 'EDU_BROKER_GUGUN'
				AND EDU_CODE LIKE #{broker_sido} || '%' 
		]]>
	</select>

</mapper>

